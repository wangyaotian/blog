# 一、倒排索引原理
## 1、Lucene索引构成
### 索引构成
> Lucene索引由下面三部分构成
![img](http://v5blog.cn/assets/img/image-20240319151517898.7a49f0c8.png)
- Term Index（词项索引）
  - Term Index是一个索引结构，用于快速查询Term Dictionary中的词项
  - Term Index通常是用Trie树（也称为 前缀树、字典树）实现的
    - 在Trie树中，每个节点代表一个字符串（前缀），每条边代表一个字符
    - 从根节点到叶子节点的路径代表一个完整的字符串
    - 当我们查找一个词项时，可以从根节点开始，沿着词项的每个字符对应的边找下去
    - 直到找到词项对应的叶子节点，或者遇到一个不存在的边
- Term Dictionary（词项字典）
    - Term Dictionary是所有所有词项的集合
    - 每个词项都关联着一个Posting List
    - 词项字典一般会存储词项的相关信息，如词项的文档频率等
    - 注：ES根据数据规模，动态选择使用哈希表、跳表、还是B+树
- Posting List（倒排表）
    - Posting List是包含了某个词项的所有文档的ID列表
    - 每个Posting List一般会包含词项频率、位置信息、偏移信息
## 2、查找过程
- 前缀树
  - 前缀树通常它用于需要前缀匹配或模糊查询的场景(并不是每次查询都必须经过)
- 项字典(Term Dictionary)
  - 一旦通过前缀树找到了某个词项，ES会在词项字典中查找这个词项的具体信息
  - 项字典根据数据规模选择不同结构存哈希表、跳表、还是B+树，可以不使用前缀树
- 倒排列表(Posting List)
  - 在找到词项后，ES会定位到对应的倒排列表
  - 倒排列表是倒排索引的核心部分，记录了所有文档中出现该词项的位置信息
- 查询优化
  - 在查找相关的倒排列表后，ES会对符合条件的文档进一步处理
  - 如果查询包含多个词项，(AND查询),ES会将多个倒排列表合并
  - 在查询结果返回前，ES会计算每个文档的相关性得分，并分解得分对文档进行排序
## 2、Posting List 倒排列表
> [1,2,3]是Posting List（倒排列表） 
- 我们有如下4条文档数据

|文档ID| 文档内容          |
|---|---------------|
|1| 人工智能成为互联网大会焦点 |
|2| 人工智能将改变世界     |
|3| 人工智能将取代人类     |
|4| 互联网的未来在人工智能   |

1. 分词
- 对于文档内容，先要经过词条化处理
- 与英文不同的是，英文通过空格分隔单词(中文需要分词工具)
- 经过分词系统进行中文分词以后把矩阵切分成一个个的词条
2.给这些document建立的倒排索引如下
- 人工，智能叫做Term(词项)
  - ES会将文档的内容分词，每个分词就是一个词项

## 3、Term Index词项索引
- Term Index是一个索引结构，用于快速查找Term Dictionary中的词项
- Term Index通常是用Trie树（也称为 前缀树、字典树）实现的
  - 在Trie树中，每个节点代表一个字符串（前缀），每条边代表一个字符
  - 从根节点到叶子节点的路径代表一个完整的字符串
  - 当我们查找一个词项时，可以从根节点开始，沿着词项的每个字符对应的边找下去
  - 直到找到词项对应的叶子节点，或者遇到一个不存在的边
- 下面是一个包含 "A", "to", "tea", "ted", "ten", "i", "in", 和 "inn" 的 trie 树
  - 这棵树不会包含所有的term，它包含的是term的一些前缀
  - 通过term index可以快速地定位到term dictionary的某个offset，然后从这个位置再往后顺序查找
  - 再加上一些压缩技术term index 的尺寸可以只有所有term的尺寸的几十分之一
  - 使得用内存缓存整个term index变成可能
![img](http://v5blog.cn/assets/img/image-20240319143138854.0b52b3b5.png)

## 4、Term Dictionary词项字典
- ES下面情况，动态选择使用哈希表、跳表、还是B+树
  - 哈希表：适合小数据集，快速查找
  - 跳表：适合大数据集，快速查找
  - B+树：适合大数据集，快速查找
- Term Dictionary是所有索引词项的集合
- 每个词项都关联着一个Posting List
- 词项字典一般会存储词项的相关信息，如词项的文档频率等
![img](http://v5blog.cn/assets/img/image-20240319151517898.7a49f0c8.png)

## 5、总结
- 为什么ES比MySQL快
  - MySQL只有term dictionary这一层，是以b-tree排序的方式存储在磁盘上的
  - 检索一个term需要若干次的random access的磁盘操作
  - 而Lucene在term dictionary的基础上添加了term index来加速检索，term index以树的形式缓存在内存中
  - 从term index查到对应的term dictionary的block位置之后，再去磁盘上找term，大大减少了磁盘的random access次数
  - MySQL是基于B+树的
  - ES的倒排索引是基于Trie树的
  
# 二、如何联合索引查询
## 1、查询合并
> 如何过滤age=18 AND gender=男 的文档
- 给定查询过滤条件：age=18 AND gender=男
- 我们可以通过以下步骤来过滤文档：
  1. 首先，我们需要在age字段上建立一个倒排索引，将所有age=18的文档ID存储在对应的倒排列表中。
  2. 然后，我们需要在gender字段上建立一个倒排索引，将所有gender=男的文档ID存储在对应的倒排列表中。
  3. 接下来，我们可以使用AND操作符将两个倒排列表进行合并。
  4. 合并后的倒排列表将只包含同时满足age=18和gender=男的文档ID。
  5. 最后，我们可以根据合并后的倒排列表来获取满足条件的文档。
  6. 在这个例子中，我们可以使用AND操作符将两个倒排列表进行合并，得到满足age=18和gender=男的文档ID。
  7. 然后，我们可以根据这些文档ID来获取满足条件的文档。
  8. 这种查询合并的方式可以快速地过滤出满足条件的文档，并且可以通过AND操作符来组合多个查询条件。
## 2、查询优化
> 如何过滤age=18 AND gender=男 的文档
- 给定查询过滤条件：age=18 AND gender=男
- 我们可以通过以下步骤来过滤文档：
  1. 首先，我们需要在age字段上建立一个倒排索引，将所有age=18的文档ID存储在对应的倒排列表中。
  2. 然后，我们需要在gender字段上建立一个倒排索引，将所有gender=男的文档ID存储在对应的倒排列表中。
  3. 接下来，我们可以使用AND操作符将两个倒排列表进行合并。
  4. 合并后的倒排列表将只包含同时满足age=18和gender=男的文档ID。
  5. 最后，我们可以根据合并后的倒排列表来获取满足条件的文档。
  6. 在这个例子中，我们可以使用AND操作符将两个倒排列表进行合并，得到满足age=18和gender=男的文档ID。
  7. 然后，我们可以根据这些文档ID来获取满足条件的文档。
  8. 这种查询合并的方式可以快速地过滤出满足条件的文档，并且可以通过AND操作符来组合多个查询条件。
  