# 一、ES功能与特点
## 1、ES是什么
> 特点：非关系型、搜索引擎、近实时搜索与分析、高可用、天然分布式、横向可扩展
- ES是一个分布式、可扩展、实时的搜索月数据分析引擎
- ES不仅仅是全文搜索，还支持结构化搜索、数据分析、复杂的语言处理、地理位置和对象间关联关系等
- ES的底层依赖于Lucene，Lucene可以说是当下最先进、高性能、全功能的搜索引擎库
> 为什么不直接使用Lucene?
- Lucene仅仅是一个库，你需要使用java并将Lucene直接集成到应用程序中
- 您可能需要获得信息检索学位才能了解其工作原理，因为Lucene非常复杂
- ES也是使用Java编写的,它的内部使用Lucene做索引与搜索
- 它的目的是隐藏Lucene的复杂性，取而代之的提供一套简单一致的RESTful API

## 2、ES主要功能
- 分布式实时文件存储，处理结构化、非结构化和半结构化数据
- 实时分析的分布式搜索引擎，为用户提供关键字查询的全文检索功能
- 是实现企业级PB级海量数据处理分析的大数据解决方案（ELK）
> ES主要致力于结构化和非结构化数据的分布式实时全文搜索及分析，使用场景
- 日志管理与分析(ELK)
- 系统指标分析
- 安全分析
- 企业搜索(OA.CRM.ERP)
- 网站搜索(电商、招聘、门户)
- 应用搜索
- 应用性能管理APM

# 二、ES主要特点
## 1、分片与集群
- ES默认把数据分成多个片，多个片可以组成一个完整的数据，这些片可以分布在集群中的各个机器节点中
- 随着后期数据的越来越大，ES集群可以增加多个分片，把多个分片分散到更多的主机节点上
- ES集群可以增加多个分片，把多个分片分散到更多的机器主机节点上，负责负载均衡，横向扩展
- 而每个查询任务提交到某一节点，该节点必须负责将数据进行整理汇聚，再返回给客户端

## 2、自动索引
- ES所有数据默认都是索引的
- ES只有不加索引才需要额外处理

## 3、搜索是近实时的
- 往es里写的数据，实际上都写到磁盘文件里去了
- 查询的时候，操作系统会将磁盘文件中的数据自动缓存到filesystem cache里面去
- es的搜索引擎严重依赖于底层的filesystem cache，所以es的搜索速度非常快
- 尽量让内存可以容纳所有的idx segment file 索引数据文件，那么你搜索的时候就基本都是走内存的，性能会非常高
![img](http://v5blog.cn/assets/img/image-20210428203110809.ea2359e7.png)
- 性能差距究竟可以有多大？我们之前很多的测试和压测
  - 如果走磁盘一般肯定上秒，搜索性能绝对是秒级别的，1秒、5秒、10秒
  - 但如果是走filesystem cache，是走内存的，那么一般来说性能比走磁盘要高一个数量级，基本上就是毫秒级别的，从几毫秒到几百毫秒不等

## 4、ES优缺点

| 功能/数据存储 | Elasticsearch | Redis/Memcache | MySQL/Oracle/DB2/SQLServer | Hadoop(Hive) | Hbase |
|--------|----------|----------------|:--------------------------:|--------------|-------|
| 存储容量   | 较大       | 较小             |             中等             | 海量           | 海量    |
| 查询时效   | 较快       | 极快             |             中等             | 低            | 中等    |
| 写入速度   | 较快       | 极快             |             中等             | 慢            | 较快    |
| 一致性与事务 |极弱        | 极弱             |             极强             | 极弱           | 极弱    |
| 查询灵活度  | 中等、全文检索  | 较差             |         非常好，支持sql          | 非常好，支持sql    | 较差    |

# 三、ES核心概念
| MySQL                | Elasticsearch      |
|----------------------|--------------------|
| 数据库（Datebase）        | 索引（index）          |
| 表（Table）             | 类型(Type)           |
| 行（Row）每一条            | 文档（Document）每一条    |
| 字段                   | 属性                 |
| 对象（Schema）           | 映射(Mapping)        |
| 索引（Index）            | 万物皆索引(不管什么数据都默认索引) |
| SQL语言（Select、update） | Query DSL(GET PUT) |

## 1、索引（index）库
- ES将它的数据存储在一个或多个索引中，可以向索引读写文档
- 索引相当于关系型数据库中的数据库
- 索引名称必须是小写的，不能包含逗号、下划线和空格
- 索引名称可以包含字母、数字和连字符
- 索引名称必须是唯一的

## 2、类型（type）表
- ES 7.0 版本开始，不再支持类型（type）
- 类型（type）是索引（index）的逻辑分区，用于存储不同类型的文档
- 一个索引可以包含多个类型

## 3、文档（document）行
- ES 中的文档是一个 JSON 对象，类似于关系型数据库中的行
- 文档可以包含多个字段
- 文档可以是任意的 JSON 结构，无需预先定义字段

## 4、Lucene Index
- 注意和ES Index区别，Lucene Index是由若干段和提交点文件组成

## 5、段（segment）
- 索引的一个逻辑分区，包含多个文档
- 每个段都有一个唯一的名称，由段的起始文档 ID 和结束文档 ID 组成
- 段是不可变的，一旦创建就不能修改或删除
- 段是只读的，只能进行查询操作
## 6、提交点（commit point）
- 提交点是一个特殊的文件，用于标记一个段的状态
- 提交点文件包含段的元数据，如段的起始文档 ID、结束文档 ID、文档总数等
- 提交点文件还包含段的元数据，如段的起始文档 ID、结束文档 ID、文档总数等

## 7、映射（mapping）
- 映射（mapping）定义了索引中的字段及其属性
- 映射指定了字段的名称、类型、分析器等信息
- 映射是在创建索引时定义的，并且不能修改
- 映射可以包含多个字段，每个字段都有一个名称和一个类型
- 映射还可以包含字段的属性，如是否存储、是否索引、是否分词等

## 8、Shard 分片
- 单台机器无法存储大量数据，es可以将一个索引中的数据切分为多个shard，分布在多台服务器上存储
- 有了shard就可以横向扩展，存储更多的数据，让搜索和分析等操作分布到多台服务器上去执行，提升吞吐量和性能
- 每个shard都是一个最小工作单元，承载一部分数据，并且可以并行处理查询和分析等操作

## 9、Replica 副本
- 为了保证数据的高可用性，es可以为每个shard创建一个或多个replica副本
- replica是shard的副本，也是一个最小工作单元，承载一部分数据，并且可以并行处理查询和分析等操作
- replica的作用是提供数据的冗余备份，当主shard故障时，可以自动切换到replica上提供服务
- replica的数量可以根据实际需求进行配置，一般建议配置为1个或多个，以提高数据的可用性和性能

## 10、Cluster 集群
- es可以将多个shard和replica组成一个cluster集群，对外提供统一的服务
- cluster是es的分布式架构，由多个节点组成，每个节点可以承载多个shard和replica
- cluster的作用是提供数据的高可用性和性能，当某个节点故障时，其他节点可以自动接管其工作
- cluster的节点可以动态添加或删除，以适应不同的负载和需求

## 11、Node 节点
- es的一个实例，负责存储数据、处理查询和分析等操作
- node可以是一个物理机，也可以是一个虚拟机，也可以是一个容器
- node可以承载多个shard和replica，也可以是一个master节点，负责管理cluster的元数据和分片分配等操作
- node的作用是提供数据的存储、查询和分析等功能，同时也负责管理cluster的元数据和分片分配等操作

# 四、ES使用
## 1、分片的设定
- 分片数过小，数据写入形成瓶颈，无法水平扩展
- 分片数过大，数据查询速度降低，无法利用多台机器的性能
- 如何计算分片数？
  - 计算公式：(总数据量 / 单台机器的容量) * 副本数
  - 分片数量最好设置为节点数的整数倍，保证每一个主机的负载是差不多一样的
  - 否则可能遇到其他主机负债正常，就某个主机负载特别高的情况
  - 例如：100GB的数据，单台机器的容量是10GB，副本数是1，那么分片数就是10 * 1 = 10
  - 如果还不能满足需求，就可以考虑增加节点数，例如：100GB的数据，单台机器的容量是10GB，副本数是1，那么分片数就是10 * 2 = 20
## 2、ES数据近实时问题
- ES数据写入之后，要经过一个refresh操作之后，才能够创建索引，进行查询
- 但是get查询很特殊，数据实时可查
  - get查询的实时性，通过每次get查询的时候
  - 如果发现该id还在内存中没有创建索引，那么首先会触发refresh操作，来让id可查
- ES的查询速度非常快，但是写入速度非常慢
  - 因为ES的写入速度非常慢，所以ES的写入操作，一般都是批量写入
  - 批量写入的速度非常快，但是批量写入的数据，可能会有丢失的风险
  - 所以ES的写入操作，一般都是先写入缓存，然后再批量写入磁盘













