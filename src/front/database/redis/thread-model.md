#### 一、Redis线程模型

##### 1、线程模型概述

- Redis底层是Reactor模型，Reactor模型有三种
    - 单线程Reactor模型
    - 多线程Reactor模型
    - 主从Reactor模型
- reids单线程理解
    - redis单线程主要指redis-server主线程，不是说Redis生命周期只有一个线程
    - redis单线程，指的是命令处理、逻辑处理在一个单线程中
    - 接收客户端请求-->解析请求-->进行数据读写等操作-->发生数据给客户端事主线程完成
    - 而是其主线程（即下图的任务队列以及事件分派器）为单线程

![img](http://v5blog.cn/assets/img/image-20241012144344155.37671041.png)

#### 二、6.0前单线模式

- 建议连接（连接事件）
    - 建立连接
        - 客户端发送TCP连接请求，连接请求被操作系统内核接收并放入等待队列
        - IO多路复用器监控等待队列，发现新连接请求，将其放入事件队列，等待被处理
    - 文件分派器
        - 文件分派器将会从事件队列中取出这个新的连接请求，将其分配给连接应答器（acceptor）处理
    - 连接应答器
        - 连接应答器的任务是接受新的连接请求，建立新的socket连接
        - 连接应答器将新的socket放入IO多路复用器监控的文件描述符集合，并向IO多路复用器发送一个读就绪信号
- 处理客户端请求（读事件）
    - 客户端发送请求到Redis服务器时，请求被IO多路复用器标记为读事件
    - IO多路复用器接收到读事件后，会将其放入事件队列中
    - Redis主线程会从事件队列中取出读事件，然后调用相应的事件处理器来处理
    - 读事件处理器将请求数据解析成Redis命令和参数，根据命令类型调用相应的命令处理函数来处理
    - 命令处理完毕后，Redis会生成一条回复消息，并将其标记为一个写事件，等待被发送回客户端
- 数据发送给客户端（写事件）
    - 当有数据需要发送回客户端时，这个发送操作会被标记为一个写事件
    - IO多路复用器会将写事件放入事件队列中
    - 主线程会从事件队列中取出写事件，调用相应的事件处理器来处理这个事件
    - 对于写事件，Redis会调用写事件处理器，将回复消息写入到socket，然后发送给客户端
- 注1：
    - 读事件和写事件都是异步处理的，不会因为一个读事件或写事件阻塞住
    - 而是会将事件放入事件队列，然后继续处理其他的事件
- 注2：下图“写发送队列”指额是返回数据给客户端，这个过程需要写入到socket

![image](http://v5blog.cn/assets/img/image-20241012145603012.648f388f.png)

#### 三、6.0之前为什么引入IO多线程

##### 1、引入原因

- 在Redis6.0版本之后，也采用了多个IO线程来处理网络请求
- 因为随着网络硬件的性能提升，redis的性能瓶颈有时会出现在网络IO的处理上
- 所以为了提高网络IO的并行渡，Redis6.0对于网络IO采用多线程来处理
- 但是对于命令的执行，Redis仍然使用单线程来处理
- 即多线程处理网络IO（’read‘、decode和encode、send阶段）
- 主线程使用单线程，执行命令处理业务逻辑

![img](http://v5blog.cn/assets/img/image-20240315150228929.9a7b0336.png)

##### 2、引入后工作流

> 主线程：执行命令，将结果写入队列
>
> 工作线程：读取请求数据、从队列中读取数据到socket、关闭socket等
>
> 原因：Redis的数据结构和操作都不是线程安全的，如果同时有多个线程对数据进行读写，可能会导致数据的不一致

- 6.0后依然需要一个主线程，可以有多个工作线程处理用户IO
- 工作线程接收到客户端请求，从socket中读取请求数据
- 主线程解析出请求命令和参数，执行请求命令，获取或修改数据，然后生成响应数据
- 主线程将响应数据写入一个中间队列，然后唤醒工作线程
- 工作线程从中间队列中取出响应数据，然后将数据写入socket，发送给客户端